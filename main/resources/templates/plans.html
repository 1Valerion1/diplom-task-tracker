<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta content="text/html" charset="UTF-8">
    <title>Статистика по вакансии</title>
    <!--  <link rel="icon"  th:src="@{/images/ourbor.png}" />-->
    <link th:href="@{/styles/plansStyle.css}" type="text/css"  rel="stylesheet" >
</head>
<body>
<header>
    <nav>
        <ul>
            <li><h3><a href="http://localhost:8081/api/v1/ouroboros">OuroborosOdyssey</a></h3></li>
            <li><a href="http://localhost:8081/api/v1/statistics">Требования на должность</a></li>
            <li><a href="http://localhost:8081/api/v1/plans">Посмотреть план изучения</a></li>
            <li><a href="http://localhost:8081/api/v1/tasks">Планировщик</a></li>
            <li><a href="http://localhost:8081/api/v1/questions">Вопросы</a></li>
            <li><a href="http://localhost:8081/api/v1/auth">Личный кабинет</a></li>

        </ul>
    </nav>
</header>

<main>
    <h4>Панель администратора</h4>

    <div class="form-container">
        <form id="createForm">
            <h3>Добавить тему</h3>

            <input type="text" id="title" placeholder="Заголовок темы" />
            <textarea id="answer" placeholder="Описание и рекомендации"></textarea>
            <input type="text" id="links" placeholder="Ссылки" />
            <button type="button" onclick="createQuestion()">Добавить</button>
            <div class="message-box" id="createMessage"></div>
        </form>


        <form id="updateForm" style="display;">
            <h3>Обновить </h3>
            <input type="hidden" id="updateId" />
            <input type="text" id="updateTitle" placeholder="Заголовок темы" />
            <textarea id="updateAnswer" placeholder="Описание и рекомендации"></textarea>
            <select class="themeSelect">
                <option value="">-- Выберите тему --</option>
                <option value="">Spring</option>

            </select>
            <input type="text" id="updateLinks" placeholder="Ссылки" />
            <button type="button" onclick="updateTheme()">Обновить</button>
            <div class="message-box" id="updateMessage"></div>
        </form>


    </div>


    <div class="main-content">
        <h3>План изучения</h3>
        <div id="plan-container">
            <div th:if="${plans != null}">
                <div class="card">
                    <div class="card-header">План изучения для разработчика: <span th:text="${plans.developer}"></span>
                    </div>
                    <div class="card-content">
                        <p>Темы:</p>
                        <ul>
                            <li th:each="theme : ${plans.theme}">
                                <div class="card">
                                    <div class="card-header">
                                        <span th:text="${theme.title}"></span></n>
                                        <button type="button" onclick="editTheme(${theme.id})">Изменить</button>
                                        <button type="button" onclick="deleteTheme(${theme.id})">Удалить</button>
                                    </div>
                                    <div class="card-content">
                                        <p>Описание:</p>
                                        <p th:utext="${theme.details}"></p>
                                        <p>Ссылки: <a th:href="${theme.links}" class="card-link"
                                                      target="_blank">Перейти</a></p>
                                        <p>Вопросы:</p>
                                        <ul>
                                            <li th:each="question : ${theme.questionsList}"
                                                th:text="${question.titleQuestions}"></li>

                                        </ul>

                                    </div>

                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
<footer>
    <p id="foot">© 2024 OuroborosOdyssey. Все права защищены.</p>
</footer>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        function fetchPlan(id) {
            const token = localStorage.getItem('token');

            console.log('Запрос к серверу с ID:', id);
            fetch(`http://localhost:8081/api/v1/plans/getOne?id=${id}`)
                .then(response => response.json())
                .then(data => {
                if (!data || !data.plans) {
                    console.error('Не удалось получить данные или данные не содержат ожидаемых полей');
                    return;
                }
                const planContainer = document.getElementById('plan-container');
                const planHtml = createPlanHtml(data);
                planContainer.innerHTML = planHtml;
            })
                .catch(error => {
                console.error('Ошибка при получении данных плана:', error);
            });
        }

        function createPlanHtml(plan) {
            const themesHtml = plan.theme.map(theme => `
                <li>
                    <div class="card">
                    <div class="card-header">
                    ${theme.title}

                   </div>
                    <div class="card-content">
                        <p>Описание:</p>
                        ${formatDetails(theme.details)}
                        <p>Ссылки: <a href="${theme.links}" class="card-link" target="_blank">Перейти</a></p>
                        <p>Вопросы:</p>
                        <ul>
                            ${theme.questionsList.map(question => `<li>${question.titleQuestions}</li>`).join('')}
                        </ul>
                    </div>
                    </div>
                </li>
            `).join('');

            return `
                <div class="card">
                    <div class="card-header">План изучения для разработчика: <span>${plan.developer}</span></div>
                    <div class="card-content">
                        <p>Темы:</p>
                        <ul>${themesHtml}</ul>
                    </div>
                </div>
            `;
        }
        window.editTheme = function(id, title, description, links) {
            document.getElementById('updateForm').style.display = 'block';
            document.getElementById('updateId').value = id;
            document.getElementById('updateTitle').value = title;
            document.getElementById('updateAnswer').value = description;
            document.getElementById('updateLinks').value = links;
        };

        window.updateTheme = function() {
            const id = document.getElementById('updateId').value;
            const title = document.getElementById('updateTitle').value;
            const description = document.getElementById('updateAnswer').value;
            const links = document.getElementById('updateLinks').value;

            fetch(`http://localhost:8081/api/v1/themes/update`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: id,
                    title: title,
                    details: description,
                    links: links
                })
            })
                .then(response => response.json())
                .then(data => {
                document.getElementById('updateMessage').innerText = 'Обновление прошло успешно!';
                fetchPlan(2);  // обновить список планов
            })
                .catch(error => {
                console.error('Ошибка при обновлении темы:', error);
                document.getElementById('updateMessage').innerText = 'Ошибка при обновлении.';
            });
        };

        window.deleteTheme = function(id) {
            const confirmDelete = confirm('Вы действительно хотите удалить эту тему?');
            if (!confirmDelete)
            return;

            fetch(`http://localhost:8081/api/v1/themes/delete/${id}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                fetchPlan(2);  // обновить список планов
            })
                .catch(error => {
                console.error('Ошибка при удалении темы:', error);
            });
        };
    });

        function formatDetails(details) {
            const paragraphs = details.split(/(?<=\.|\?|\!|\:)\s/);
            const formattedParagraphs = paragraphs.map(paragraph => `<p>${paragraph.trim()}</p>`).join('');

            if (details.length > 10) {
                return `
            <div class="collapsible-content">
                <div class="summary">${formattedParagraphs.slice(0, 200)}</div>
                <div class="full-text hidden">${formattedParagraphs}</div>
                <button onclick="this.previousElementSibling.classList.toggle('hidden');
                        this.textContent = this.previousElementSibling.classList.contains('hidden') ?
                        'Показать больше' : 'Показать меньше';">Показать больше</button>
            </div>
        `;
            }
            return formattedParagraphs;
        }

        fetchPlan(2);
    });
</script>


</body>
</html>