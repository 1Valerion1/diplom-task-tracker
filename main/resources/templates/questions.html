<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta content="text/html" ; charset="UTF-8">
    <title>Статистика по вакансии</title>
    <link rel="icon" th:src="@{/images/ourbor.png}"/>
    <link th:href="@{/styles/questionsStyle.css}" rel="stylesheet" type="text/css" />

</head>
<body>
<header>
    <nav>
        <ul>
            <!--            <li><svg><img th:src="@{/images/ourbor.png}"></svg></li>-->
            <li><h3><a href="http://localhost:8081/api/v1/ouroboros">OuroborosOdyssey</a></h3></li>
            <li><a href="http://localhost:8081/api/v1/statistics">Требования на должность</a></li>
            <li><a href="http://localhost:8081/api/v1/plans">Посмотреть план изучения</a></li>
            <li><a href="http://localhost:8081/api/v1/tasks">Планировщик</a></li>
            <li><a href="http://localhost:8081/api/v1/questions">Вопросы</a></li>
            <li><a href="http://localhost:8081/api/v1/auth">Личный кабинет</a></li>

        </ul>
    </nav>
</header>
<main>
    <h3>Панель администратора</h3>

    <div class="form-container">
        <form id="createForm">
            <h3>Добавить вопрос</h3>

            <input type="text" id="title" placeholder="Заголовок вопроса" />
            <textarea id="answer" placeholder="Ответ"></textarea>
            <select class="themeSelect">
                <option value="">-- Выберите тему --</option>
            </select>
            <input type="text" id="links" placeholder="Ссылка" />
            <button type="button" onclick="createQuestion()">Добавить</button>
            <div class="message-box" id="createMessage"></div>
        </form>


        <form id="updateForm" style="display;">
            <h3>Обновить вопрос</h3>
            <input type="hidden" id="updateId" />
            <input type="text" id="updateTitle" placeholder="Заголовок вопроса" />
            <textarea id="updateAnswer" placeholder="Ответ"></textarea>
            <select class="themeSelect">
                <option value="">-- Выберите тему --</option>
            </select>
            <input type="text" id="updateLinks" placeholder="Ссылка" />
            <button type="button" onclick="updateQuestion()">Обновить</button>
            <div class="message-box" id="updateMessage"></div>
        </form>

<!--        <form id="deleteForm" style="display;">-->
<!--            <h3>Удалить вопрос</h3>-->
<!--            <input type="text" id="deleteId" placeholder="ID вопроса" />-->
<!--            <button type="button" onclick="deleteQuestion()">Удалить</button>-->
<!--            <div class="message-box" id="deleteMessage"></div>-->
<!--        </form>-->
    </div>

    <!-- Боковая панель для выбора темы -->
    <div class="sidebar">
        <h3>Фильтр тем:</h3>
        <select class="themeSelect">
            <option value="">-- Выберите тему --</option>
            <option value="all">Все</option>
            <!--            <option th:each="theme : ${themes}" th:value="${theme.id}" th:text="${theme.name}">Тема 1</option>-->
        </select>
        <button onclick="fetchQuestionsByTheme()">Применить фильтр</button>
    </div>

    <div class="main-content">
        <h3>Вопросы с собеседований на Java Developer </h3>
        <div class="blockContent">
            <table>
                <thead>
                <tr>
                    <th>Тема</th>
                    <th>Вопрос</th>
                    <th>Cсылка</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="question : ${questions}">
                    <td th:text="${question.nameThemes}">Sample Theme</td>
                    <td th:text="${question.titleQuestions}" >Sample Title</td>
                    <td th:text="${question.links}">Sample Link</td>
                    <td><button onclick="showUpdateForm(${question.id})">Обновить</button></td>
                    <td><button onclick="showDeleteForm(${question.id})">Удалить</button></td>
                </tr>
                </tbody>
            </table>
        </div>
        <div id="pagination">
            <button onclick="previousPage()">Предыдущая</button>
            <span id="page-number">1</span>
            <button onclick="nextPage()">Следующая</button>
        </div>

    </div>
</main>

<footer>
    <p id="foot">© 2024 OuroborosOdyssey. Все права защищены.</p>
</footer>

<script>
    let currentPage = 1;
    const questionsPerPage = 50;

    // Глобальная переменная для хранения всех вопросов
    let allQuestions = [];

    function nextPage() {
        currentPage++;
        displayQuestions();
    }

    function previousPage() {
        if (currentPage > 1) {
            currentPage--;
            displayQuestions();
        }
    }

    function displayQuestions() {
        const startIndex = (currentPage - 1) * questionsPerPage;
        const endIndex = Math.min(startIndex + questionsPerPage, allQuestions.length);
        const paginatedQuestions = allQuestions.slice(startIndex, endIndex);
        updateTable(paginatedQuestions);

        // Обновление состояния кнопок
        document.querySelector('#pagination button[onclick="previousPage()"]').disabled = currentPage === 1;
        document.querySelector('#pagination button[onclick="nextPage()"]').disabled = endIndex >= allQuestions.length;
    }

    function showUpdateForm(id) {
        const question = allQuestions.find(q => q.id === id);

        document.getElementById('updateId').value = question.id;
        document.getElementById('updateTitle').value = question.titleQuestions;
        document.getElementById('updateAnswer').value = question.answer;
        document.querySelector('.themeSelect').value = question.themeId;
        document.getElementById('updateLinks').value = question.links;

        document.getElementById('updateForm').style.display = 'block';
    }
    function showDeleteForm(id) {
        const confirmDelete = confirm('Вы уверены, что хотите удалить этот вопрос?');

        if (confirmDelete) {
            deleteQuestion(id);
        }
    }
    function deleteQuestion(id) {

        fetch(`http://localhost:8081/api/v1/questions/delete/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
            if (response.ok) {

                fetchQuestionsByTheme();
            } else {
                console.error('Ошибка при удалении вопроса');
            }
        })
            .catch(error => console.error('Ошибка:', error));
    }
    function updateTable(questions) {
        const tableBody = document.querySelector('table tbody');
        tableBody.innerHTML = '';

        if (!questions.length) {
            tableBody.innerHTML = '<tr><td colspan="3">Вопросы не найдены.</td></tr>';
        } else {
            questions.forEach(question => {
                const row = document.createElement('tr');
                row.innerHTML = `
                <td>${question.nameThemes}</td>
                <td>${question.titleQuestions}</td>

                <td>${question.links}</td>
            `;
                tableBody.appendChild(row);
            });
        }

        document.getElementById('page-number').textContent = currentPage;
    }


    function populateQuestions(questions) {
        allQuestions = [];
        allQuestions = questions;
        displayQuestions();
    }

    document.addEventListener('DOMContentLoaded', function() {
        fetchThemes();
    });

    function fetchThemes() {
        const selectElements = document.querySelectorAll('.themeSelect');
        selectElements.forEach(selectElement => {
            fetch(`http://localhost:8081/api/v1/themes/getALL`)
                .then(response => response.json())
                .then(themes => {
                themes.forEach(theme => {
                    const option = document.createElement('option');
                    option.value = theme.id;
                    option.textContent = theme.title;
                    selectElement.appendChild(option);
                });
            })
                .catch(error => console.error('Error:', error));
        });
    }

    function fetchQuestionsByTheme() {
        const themeIdString = document.querySelectorAll('.themeSelect');
        themeSelectElements.forEach(themeSelect => {
            const themeIdString = themeSelect.value;
        let url = 'http://localhost:8081/api/v1/questions/';

        if (themeIdString === 'all') {
            url += 'getAll';
        } else {
            url += `getQuestionsThemes?themeId=${themeIdString}`;
        }

        fetch(url)
            .then(response => response.json())
            .then(questions => populateQuestions(questions))
            .catch(error => console.error('Error:', error));
            });
    }


    function populateQuestions(questions) {
        const tableBody = document.querySelector('table tbody');
        tableBody.innerHTML = '';
        questions.forEach(question => {
            const row = `<tr>
            <td>${question.nameThemes}</td>
            <td>${question.titleQuestions}</td>
             <td>${question.links}</td>
        </tr>`;
            tableBody.innerHTML += row;
        });
    }
</script>
</body>
</html>
